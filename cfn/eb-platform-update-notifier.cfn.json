{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Metadata":{
      "AWS::CloudFormation::Interface":{
         "ParameterGroups":[
            {
               "Label":{
                  "default":"Function Code Location"
               },
               "Parameters":[
                  "FunctionS3Bucket",
                  "FunctionS3Key"
               ]
            },
            {
               "Label":{
                  "default":"Slack Configuration"
               },
               "Parameters":[
                  "SlackApiKey",
                  "SlackChannel"
               ]
            },
            {
               "Label":{
                  "default":"VictorOps Configuration (optional)"
               },
               "Parameters":[
                  "VictorOpsEndpoint"
               ]
            }
         ]
      }
   },
   "Parameters":{
      "FunctionS3Bucket":{
         "Type":"String",
         "Default":"",
         "Description":"S3 bucket containing the Lambda function zip file"
      },
      "FunctionS3Key":{
         "Type":"String",
         "Default":"",
         "Description":"S3 key within the bucket for the function (ie. folder/foo.zip)"
      },
      "SlackApiKey":{
         "Type":"String",
         "Default":"",
         "Description":"Valid Slack API Key (obtain by creating a bot)"
      },
      "SlackChannel":{
         "Type":"String",
         "Default":"#general",
         "Description":"Slack Channel to post scaling notifications to"
      },
      "VictorOpsEndpoint":{
         "Type":"String",
         "Default":"",
         "Description":"(optional) VictorOps endpoint to notify"
      }
   },
   "Resources":{
      "FunctionRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "Path":"/elasticbeanstalk/",
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Policies":[
               {
                  "PolicyName":"EBPlatformUpdateNotify",
                  "PolicyDocument":{
                     "Version":"2012-10-17",
                     "Statement":[
                        {
                           "Sid":"Logging",
                           "Action":[
                              "logs:CreateLogGroup",
                              "logs:CreateLogStream",
                              "logs:PutLogEvents"
                           ],
                           "Effect":"Allow",
                           "Resource":"arn:aws:logs:*:*:*:*"
                        },
                        {
                          "Sid":"Beanstalk",
                          "Action":[
                             "elasticbeanstalk:DescribeEnvironments"
                          ],
                          "Effect":"Allow",
                          "Resource":"*"
                        }
                     ]
                  }
               }
            ]
         }
      },
      "NotifySlackFunction":{
         "Type":"AWS::Lambda::Function",
         "Properties":{
            "FunctionName":"ElasticBeanstalkPlatfomUpdateSlackNotifier",
            "Description":"Notify in Slack EB managed updates take place",
            "Role":{
               "Fn::GetAtt":[
                  "FunctionRole",
                  "Arn"
               ]
            },
            "Runtime":"python3.8",
            "Handler":"eb-platform-update-notify-slack.lambda_handler",
            "MemorySize":128,
            "Timeout":20,
            "Environment":{
               "Variables":{
                  "slack_api_token":{
                     "Ref":"SlackApiKey"
                  },
                  "slack_channel":{
                     "Ref":"SlackChannel"
                  },
                  "victorops_webhook_url":{
                    "Ref": "VictorOpsEndpoint"
                  }
               }
            },
            "Code":{
               "S3Bucket":{
                  "Ref":"FunctionS3Bucket"
               },
               "S3Key":{
                  "Ref":"FunctionS3Key"
               }
            }
         }
      },
      "EBUpdateRule":{
         "Type":"AWS::Events::Rule",
         "Properties":{
            "Description":"Triggered when updates occur to beanstalk environments",
            "Name":"ElasticBeanstalkUpdateEnvironmentEvent",
            "State":"ENABLED",
            "EventPattern":{
               "source":[
                  "aws.elasticbeanstalk"
               ],
               "detail":{
                  "eventName":[
                     "UpdateEnvironment"
                  ]
               }
            },
            "Targets":[
               {
                  "Arn":{
                     "Fn::GetAtt":[
                        "NotifySlackFunction",
                        "Arn"
                     ]
                  },
                  "Id":"EBUpdateNotifySlackFunction"
               }
            ]
         }
      },
      "LambdaInvokePermission":{
         "Type":"AWS::Lambda::Permission",
         "Properties":{
            "Action":"lambda:InvokeFunction",
            "FunctionName":{
               "Fn::GetAtt":[
                  "NotifySlackFunction",
                  "Arn"
               ]
            },
            "Principal":"events.amazonaws.com",
            "SourceArn":{
               "Fn::GetAtt":[
                  "EBUpdateRule",
                  "Arn"
               ]
            }
         }
      }
   }
}
